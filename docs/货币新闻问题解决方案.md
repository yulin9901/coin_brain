# 货币新闻问题解决方案

## 问题描述

1. **数据保留问题**：只留存了最新的50条数据，旧数据没有保存
2. **数据格式问题**：CoinMarketCal保存的数据格式不统一，内容摘要格式混乱

## 解决方案

### 1. 数据保留策略优化

#### 新增功能
- **自动数据清理机制**：实现了定时清理旧数据的功能
- **可配置的数据保留策略**：支持不同类型数据的不同保留期限
- **数据归档功能**：可选择将旧数据归档而非直接删除

#### 实现细节
- 创建了 `app/data_processors/data_cleanup.py` 模块
- 添加了 `DataCleanupManager` 类来管理数据清理
- 集成到定时任务系统中，每日自动执行

#### 配置选项
```python
# 数据保留策略配置
DATA_CLEANUP_TIME = "02:00"  # 每日数据清理时间
HOT_TOPICS_RETENTION_DAYS = 30  # 热点话题数据保留天数
MARKET_FLOWS_RETENTION_DAYS = 7  # 市场资金流向数据保留天数
KLINE_RETENTION_DAYS = 30  # K线数据保留天数
```

### 2. 数据格式优化

#### 改进内容
- **统一的内容摘要格式**：改进了CoinMarketCal数据的解析和格式化
- **更好的币种信息展示**：包含币种全名和符号
- **结构化的描述信息**：使用分隔符组织不同类型的信息

#### 格式示例
**优化前：**
```
Stablecoins Talk - 相关币种: Hive (HIVE), Quickswap (QUICK)
```

**优化后：**
```
Stablecoins Talk | 相关币种: Hive (HIVE), Quickswap (QUICK)
```

### 3. 系统集成

#### 定时任务集成
- 在 `app/scheduler/scheduler.py` 中添加了数据清理任务
- 默认在每日凌晨2点执行数据清理
- 可通过配置文件自定义清理时间

#### 任务调度
```python
# 每日数据清理任务
data_cleanup_time = getattr(self.config, "DATA_CLEANUP_TIME", "02:00")
schedule.every().day.at(data_cleanup_time).do(self.cleanup_old_data)
```

## 使用方法

### 1. 配置数据保留策略

在 `config/config.py` 中添加以下配置：

```python
# 数据保留策略配置
DATA_CLEANUP_TIME = "02:00"  # 每日数据清理时间
HOT_TOPICS_RETENTION_DAYS = 30  # 热点话题数据保留天数
MARKET_FLOWS_RETENTION_DAYS = 7  # 市场资金流向数据保留天数
KLINE_RETENTION_DAYS = 30  # K线数据保留天数

# 数据归档配置（可选）
ENABLE_DATA_ARCHIVING = False  # 是否启用数据归档功能
ARCHIVE_RETENTION_DAYS = 90  # 归档前数据保留天数
```

### 2. 手动执行数据清理

```bash
# 测试数据清理功能
python app/data_processors/data_cleanup.py

# 查看数据库统计信息
python test_data_check.py
```

### 3. 启动定时任务

```bash
# 启动完整的定时任务系统（包含数据清理）
python app/scheduler/scheduler.py
```

## 功能特性

### 数据清理管理器功能
- ✅ 清理超期的热点话题数据
- ✅ 清理超期的市场资金流向数据
- ✅ 清理超期的K线数据
- ✅ 获取数据库表统计信息
- ✅ 支持数据归档功能
- ✅ 可配置的保留策略

### 数据格式优化功能
- ✅ 改进的CoinMarketCal数据解析
- ✅ 统一的内容摘要格式
- ✅ 更好的币种信息展示
- ✅ 结构化的描述信息

### 系统集成功能
- ✅ 集成到定时任务系统
- ✅ 可配置的执行时间
- ✅ 详细的日志记录
- ✅ 错误处理和恢复

## 测试结果

### 数据清理测试
```
数据库表统计信息:
hot_topics: 54条记录
  最早记录: 2025-05-26 18:00:01
  最新记录: 2025-05-27 14:00:07
market_fund_flows: 273条记录
  最早记录: 2025-05-26 17:00:08
  最新记录: 2025-05-27 14:00:16
kline_data: 28855条记录
  最早记录: 2025-05-26 17:00:24
  最新记录: 2025-05-27 14:01:00
```

### 数据格式测试
最新的CoinMarketCal数据格式已优化：
```
标题: AMA with Soulbound TV
内容摘要: AMA with Soulbound TV | 相关币种: Livepeer (LPT)
```

## 注意事项

1. **数据备份**：在首次启用数据清理功能前，建议备份重要数据
2. **保留期限**：根据实际需求调整数据保留天数
3. **执行时间**：建议在系统负载较低的时段执行数据清理
4. **监控日志**：定期检查清理任务的执行日志

## 后续优化建议

1. **数据压缩**：对归档数据进行压缩存储
2. **分区清理**：按时间分区进行更高效的数据清理
3. **性能监控**：添加数据清理性能监控指标
4. **智能保留**：基于数据重要性的智能保留策略
